From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Mon, 30 Apr 2018 17:15:26 -0400
Subject: [PATCH] Block Enderpearl Travel Exploit

Players are able to use alt accounts and enderpearls to travel
long distances utilizing the pearls in unloaded chunks and loading
the chunk later when convenient.

This disables that by not saving the thrower when the chunk is unloaded.

This is mainly useful for survival servers that do not allow freeform teleporting.

diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
index cebf1a623a9bec72d60fdd23dda01868ef6431d4..e8e1e7dafaf1c105b2f58cf3e118e3d665dc50ec 100644
--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
@@ -363,4 +363,10 @@ public class PaperWorldConfig {
     private void disableSprintInterruptionOnAttack() {
         disableSprintInterruptionOnAttack = getBoolean("game-mechanics.disable-sprint-interruption-on-attack", false);
     }
+
+    public boolean disableEnderpearlExploit = true;
+    private void disableEnderpearlExploit() {
+        disableEnderpearlExploit = getBoolean("game-mechanics.disable-unloaded-chunk-enderpearl-exploit", disableEnderpearlExploit);
+        log("Disable Unloaded Chunk Enderpearl Exploit: " + (disableEnderpearlExploit ? "enabled" : "disabled"));
+    }
 }
diff --git a/src/main/java/net/minecraft/world/entity/projectile/IProjectile.java b/src/main/java/net/minecraft/world/entity/projectile/IProjectile.java
index 5c9ffd02b4f2977ee13a962a214887f74c91594f..8f14e1ebefe172e056a04bd7b6f55b9bbb1e7b2e 100644
--- a/src/main/java/net/minecraft/world/entity/projectile/IProjectile.java
+++ b/src/main/java/net/minecraft/world/entity/projectile/IProjectile.java
@@ -63,6 +63,7 @@ public abstract class IProjectile extends Entity {
     protected void loadData(NBTTagCompound nbttagcompound) {
         if (nbttagcompound.b("Owner")) {
             this.shooter = nbttagcompound.a("Owner");
+            if (this instanceof EntityEnderPearl && this.world != null && this.world.paperConfig.disableEnderpearlExploit) { this.shooter = null; } // Paper - Don't store shooter name for pearls to block enderpearl travel exploit
         }
 
         this.d = nbttagcompound.getBoolean("LeftOwner");
diff --git a/src/main/java/net/minecraft/server/EntityEnderPearl.java b/src/main/java/net/minecraft/server/EntityEnderPearl.java
index 63b4a449b56ef549830e4bbd3eab116e64379189..9126c0a86c6c8755901d99e5dc34ce651789a581 100644
--- a/src/main/java/net/minecraft/server/EntityEnderPearl.java
+++ b/src/main/java/net/minecraft/server/EntityEnderPearl.java
@@ -93,6 +93,14 @@ public class EntityEnderPearl extends EntityProjectileThrowable {
             super.tick();
         }
 
+        // Paper start
+        if(this.world.paperConfig.disableEnderpearlExploit){
+            PlayerChunk playerChunk = ((ChunkProviderServer)this.world.getChunkProvider()).playerChunkMap.getVisibleChunk(new ChunkCoordIntPair((int) Math.floor(this.locX()) >> 4, (int) Math.floor(this.locZ()) >> 4).pair());
+            if (playerChunk == null || !PlayerChunk.getChunkState(playerChunk.getTicketLevel()).isAtLeast(PlayerChunk.State.ENTITY_TICKING)){
+                this.setShooter(null);
+            }
+        }
+        // Paper end
     }
 
     @Nullable
